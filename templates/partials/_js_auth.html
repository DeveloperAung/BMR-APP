<script>
    (function() {
        // Prevent double-init
        if (window._JS_AUTH_INIT) return;
        window._JS_AUTH_INIT = true;
    
        // CONFIGURATION
        const GOOGLE_CLIENT_ID = "{{ GOOGLE_CLIENT_ID|default:'' }}";
        // Dynamically determine Redirect URI based on current browser URL
        // This ensures 'localhost' works on localhost and 'bmr-sg.cloud' works on cloud
        const REDIRECT_URI = window.location.origin + '/google-callback/';
    
        function initGoogleAuth() {
            const btn = document.getElementById('googleSignInBtn');
            if (!btn) return;
    
            if (!GOOGLE_CLIENT_ID) {
                console.error("Google Client ID missing");
                btn.disabled = true;
                return;
            }
    
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                startGoogleFlow(btn);
            });
        }
    
        function startGoogleFlow(btn) {
            // 1. Show Loading Spinner
            const originalText = btn.innerHTML;
            setLoading(btn, true, 'Opening Google...');
    
            // 2. Generate State (CSRF)
            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('oauth_state', state);
    
            // 3. Build Google URL
            const params = new URLSearchParams({
                client_id: GOOGLE_CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                response_type: 'code',
                scope: 'openid email profile',
                access_type: 'offline',
                prompt: 'select_account',
                state: state
            });
            const url = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
    
            // 4. Open Popup
            const w = 500, h = 600;
            const left = (screen.width/2)-(w/2);
            const top = (screen.height/2)-(h/2);
            
            let popup = window.open(url, 'google_login', `width=${w},height=${h},top=${top},left=${left}`);
    
            if (!popup) {
                setLoading(btn, false, originalText);
                alert("Please allow popups for Google Login.");
                return;
            }
    
            // 5. Listen for Response
            let isComplete = false;
            
            const msgListener = function(event) {
                // Verify origin if needed, but for now accept to support localhost/127 mixed
                if (!event.data || !event.data.type) return;
    
                if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
                    isComplete = true;
                    window.removeEventListener('message', msgListener);
                    popup.close();
                    
                    // Exchange Code
                    setLoading(btn, true, 'Verifying...');
                    exchangeCode(event.data.code, btn, originalText);
                
                } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
                    isComplete = true;
                    window.removeEventListener('message', msgListener);
                    popup.close();
                    setLoading(btn, false, originalText);
                    alert("Login failed: " + event.data.error);
                }
            };
    
            window.addEventListener('message', msgListener);
    
            // 6. Polling (Backup if popup closed manually)
            const timer = setInterval(() => {
                if (popup.closed) {
                    clearInterval(timer);
                    if (!isComplete) {
                        // Check fallback storage (fix for some mobile browsers)
                        const fallback = localStorage.getItem('google_auth_complete');
                        if (fallback) {
                            localStorage.removeItem('google_auth_complete');
                            const data = JSON.parse(fallback);
                            if(data.type === 'GOOGLE_AUTH_SUCCESS') {
                                 window.removeEventListener('message', msgListener);
                                 setLoading(btn, true, 'Verifying...');
                                 exchangeCode(data.code, btn, originalText);
                                 return;
                            }
                        }
    
                        // Really closed without login
                        window.removeEventListener('message', msgListener);
                        setLoading(btn, false, originalText);
                    }
                }
            }, 1000);
        }
    
        async function exchangeCode(code, btn, originalText) {
            try {
                const response = await axios.post('/api/auth/google-oauth/', {
                    code: code,
                    redirect_uri: REDIRECT_URI // Must match exactly
                });
    
                if (response.data.success) {
                    const { tokens, user } = response.data.data;
                    
                    // Save Tokens
                    localStorage.setItem('access_token', tokens.access);
                    localStorage.setItem('refresh_token', tokens.refresh);
                    localStorage.setItem('user_data', JSON.stringify(user));
                    
                    // Redirect
                    setLoading(btn, true, 'Redirecting...');
                    const dashboard = user.is_staff ? '/i/dashboard/' : '/e/dashboard/';
                    window.location.href = dashboard;
                } else {
                    throw new Error(response.data.message);
                }
            } catch (err) {
                console.error(err);
                setLoading(btn, false, originalText);
                const msg = err.response?.data?.message || err.message || "Login failed";
                alert(msg);
            }
        }
    
        function setLoading(btn, isLoading, text) {
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> ${text}`;
            } else {
                btn.disabled = false;
                btn.innerHTML = text; // text is actually the original HTML
            }
        }
    
        document.addEventListener('DOMContentLoaded', initGoogleAuth);
    })();
    </script>