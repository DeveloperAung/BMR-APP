<script>
    const GOOGLE_CLIENT_ID = "{{ GOOGLE_CLIENT_ID|default:'' }}";

    function debugLog(message) {
        const debugElement = document.getElementById('debugConsole');
        const timestamp = new Date().toLocaleTimeString();
        debugElement.innerHTML += `[${timestamp}] ${message}<br>`;
        debugElement.scrollTop = debugElement.scrollHeight;
        window.console.log(message);
    }

    function initCustomGoogleAuth() {
        const googleBtn = document.getElementById('googleSignInBtn');

        if (!GOOGLE_CLIENT_ID) {
            googleBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Google Client ID not configured';
            googleBtn.disabled = true;
            debugLog('‚ùå Google Client ID not configured');
            return;
        }

        debugLog(`‚úÖ Google Client ID configured: ${GOOGLE_CLIENT_ID.substring(0, 20)}...`);

        googleBtn.addEventListener('click', function() {
            debugLog('üîò Google Sign-In button clicked');
            performGoogleOAuth();
        });
    }

    function performGoogleOAuth() {
        const authUrl = buildGoogleAuthUrl();
        debugLog(`üîó OAuth URL: ${authUrl}`);

        // Clear any previous auth results
        localStorage.removeItem('google_auth_result');
        debugLog('üßπ Cleared previous auth results');

        // Open popup window
        const popup = window.open(
            authUrl,
            'google_oauth',
            'width=500,height=600,scrollbars=yes,resizable=yes,toolbar=no,menubar=no'
        );

        if (!popup) {
            debugLog('‚ùå Popup was blocked');
            showAlert('danger', 'Popup was blocked. Please allow popups and try again.');
            return;
        }

        debugLog('‚úÖ Popup opened successfully');
        let messageReceived = false;

        // Listen for messages from popup
        const messageListener = function(event) {
            debugLog(`üì® Message received: ${JSON.stringify(event.data)}`);

            if (event.origin !== window.location.origin) {
                debugLog(`‚ùå Origin mismatch: ${event.origin} vs ${window.location.origin}`);
                return;
            }

            if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
                debugLog('‚úÖ Google auth success message received');
                messageReceived = true;
                popup.close();
                handleAuthorizationCode(event.data.code);
                window.removeEventListener('message', messageListener);
            } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
                debugLog('‚ùå Google auth error message received');
                messageReceived = true;
                popup.close();
                showAlert('danger', 'Google authentication failed: ' + event.data.error);
                window.removeEventListener('message', messageListener);
            }
        };

        window.addEventListener('message', messageListener, false);
        debugLog('üëÇ Message listener attached');

        // Check for popup completion and localStorage fallback
        const checkClosed = setInterval(function() {
            if (popup.closed) {
                debugLog('üîí Popup closed detected');
                clearInterval(checkClosed);
                window.removeEventListener('message', messageListener);

                if (!messageReceived) {
                    debugLog('‚è≥ No message received, checking localStorage fallback...');
                    // Check localStorage for fallback result
                    setTimeout(function() {
                        const storedResult = localStorage.getItem('google_auth_result');
                        if (storedResult) {
                            debugLog(`üì¶ Found stored result: ${storedResult}`);
                            try {
                                const result = JSON.parse(storedResult);
                                localStorage.removeItem('google_auth_result');

                                if (result.type === 'GOOGLE_AUTH_SUCCESS') {
                                    debugLog('‚úÖ Processing stored success result');
                                    handleAuthorizationCode(result.code);
                                } else if (result.type === 'GOOGLE_AUTH_ERROR') {
                                    debugLog('‚ùå Processing stored error result');
                                    showAlert('danger', 'Google authentication failed: ' + result.error);
                                }
                            } catch (e) {
                                debugLog(`‚ùå Error parsing stored result: ${e.message}`);
                                showAlert('info', 'Google authentication was cancelled or incomplete.');
                            }
                        } else {
                            debugLog('üì≠ No stored result found');
                            showAlert('info', 'Google authentication was cancelled.');
                        }
                    }, 2000); // Wait longer for localStorage to be set
                }
            }
        }, 1000);
    }

    function buildGoogleAuthUrl() {
        const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
        const params = new URLSearchParams({
            client_id: GOOGLE_CLIENT_ID,
            redirect_uri: window.location.origin + '/google-callback/',
            response_type: 'code',
            scope: 'openid email profile',
            access_type: 'offline',
            prompt: 'select_account'
        });

        return `${baseUrl}?${params.toString()}`;
    }

    async function handleAuthorizationCode(code) {
        debugLog(`üîë Handling authorization code: ${code.substring(0, 20)}...`);
        showAlert('info', 'Processing Google authentication...');

        try {
            debugLog('üì§ Sending code to Django backend...');
            const response = await axios.post('/api/auth/google-oauth/', {
                code: code,
                redirect_uri: window.location.origin + '/google-callback/'
            });

            debugLog(`üì• Backend response: ${JSON.stringify(response.data)}`);

            if (response.data.success) {
                localStorage.setItem('access_token', response.data.data.tokens.access);
                localStorage.setItem('refresh_token', response.data.data.tokens.refresh);
                axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.data.tokens.access}`;

                // Check if user is staff and route accordingly
                console.log(response.data);
                const isStaff = response.data.data.user.is_staff; // Adjust path based on your API response structure
                alert(isStaff);
                const dashboardUrl = isStaff ? '/i/dashboard/' : '/e/dashboard/';

                showAlert('success', response.data.message + ' Redirecting...');
                setTimeout(() => {
                    window.location.href = dashboardUrl;
                }, 1500);
            }
        } catch (error) {
            debugLog(`‚ùå Backend error: ${error.message}`);
            console.error('Google OAuth error:', error);
            const message = error.response?.data?.message || 'Google authentication failed';
            showAlert('danger', message);
        }
    }

    // Test functions
    function testCallback() {
        debugLog('üß™ Testing callback communication...');
        const testUrl = '/google-callback/?code=test123';
        const popup = window.open(testUrl, 'test_popup', 'width=500,height=600');

        window.addEventListener('message', function(event) {
            debugLog(`üß™ Test message received: ${JSON.stringify(event.data)}`);
        }, false);
    }

    function checkStorage() {
        debugLog('üß™ Checking localStorage...');
        const stored = localStorage.getItem('google_auth_result');
        if (stored) {
            debugLog(`üì¶ Found: ${stored}`);
        } else {
            debugLog('üì≠ No stored auth result');
        }
    }

    // Regular form login
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const submitBtn = document.getElementById('loginBtnText');

        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Logging in...';

        try {
            const response = await axios.post('/api/auth/login/', {
                email: email,
                password: password
            });

            if (response.data.success) {
                localStorage.setItem('access_token', response.data.data.tokens.access);
                localStorage.setItem('refresh_token', response.data.data.tokens.refresh);
                axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.data.tokens.access}`;

                // Check if user is staff and route accordingly
                const isStaff = response.data.data.user.is_staff; // Adjust path based on your API response structure
                alert(isStaff);
                const dashboardUrl = isStaff ? '/i/dashboard/' : '/e/dashboard/';

                showAlert('success', response.data.message + ' Redirecting...');
                setTimeout(() => {
                    window.location.href = dashboardUrl;
                }, 1500);
            }
        } catch (error) {
            const message = error.response?.data?.message || 'Login failed';
            showAlert('danger', message);
            submitBtn.innerHTML = 'Login';
        }
    });

    function showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer');
        alertContainer.querySelectorAll(`.alert-${type}`).forEach(alert => alert.remove());

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);

        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 8000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('üöÄ Page loaded, initializing...');
        initCustomGoogleAuth();

        // Set up test buttons
        document.getElementById('testCallback').onclick = testCallback;
        document.getElementById('checkStorage').onclick = checkStorage;

        // Check for any stored auth results on page load
        setTimeout(checkStorage, 1000);
    });
</script>