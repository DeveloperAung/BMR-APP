<script>
    // Configuration from Django context
    const GOOGLE_CLIENT_ID = "{{ GOOGLE_CLIENT_ID|default:'' }}";
    
    // Use window.location.origin to ensure consistency between Console and Code
    const REDIRECT_URI = window.location.origin + '/google-callback/';

    function debugLog(message) {
        const debugElement = document.getElementById('debugConsole');
        if (debugElement) {
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML += `[${timestamp}] ${message}<br>`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        window.console.log(message);
    }

    /**
     * Initializes the Google Auth UI
     */
    function initCustomGoogleAuth() {
        const googleBtn = document.getElementById('googleSignInBtn');

        if (!GOOGLE_CLIENT_ID) {
            googleBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Google Client ID Missing';
            googleBtn.disabled = true;
            debugLog('‚ùå Google Client ID not configured in settings.py');
            return;
        }

        debugLog(`‚úÖ Google Auth Initialized (Client ID: ${GOOGLE_CLIENT_ID.substring(0, 10)}...)`);

        googleBtn.addEventListener('click', function() {
            debugLog('üîò Starting Google OAuth flow...');
            performGoogleOAuth();
        });
    }

    /**
     * Generates a random state string for security (CSRF protection)
     */
    function generateState() {
        const array = new Uint32Array(1);
        window.crypto.getRandomValues(array);
        const state = array[0].toString(36);
        localStorage.setItem('oauth_state', state);
        return state;
    }

    /**
     * Opens the Google OAuth Popup
     */
    function performGoogleOAuth() {
        const state = generateState();
        
        const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
        const params = new URLSearchParams({
            client_id: GOOGLE_CLIENT_ID,
            redirect_uri: REDIRECT_URI,
            response_type: 'code',
            scope: 'openid email profile',
            access_type: 'offline',
            prompt: 'select_account',
            state: state  // Security requirement
        });

        const authUrl = `${baseUrl}?${params.toString()}`;
        
        // Popup centering logic
        const width = 500, height = 600;
        const left = (window.innerWidth / 2) - (width / 2);
        const top = (window.innerHeight / 2) - (height / 2);

        const popup = window.open(
            authUrl,
            'google_oauth',
            `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`
        );

        if (!popup || popup.closed || typeof popup.closed == 'undefined') {
            debugLog('‚ùå Popup blocked by browser');
            showAlert('danger', 'Popup was blocked. Please enable popups for this site.');
            return;
        }

        // Setup message listener for the popup result
        const messageListener = async function(event) {
            // Only accept messages from our own domain
            if (event.origin !== window.location.origin) return;

            const { type, code, error } = event.data;

            if (type === 'GOOGLE_AUTH_SUCCESS') {
                debugLog('‚úÖ Authorization code received from popup');
                window.removeEventListener('message', messageListener);
                handleAuthorizationCode(code);
            } else if (type === 'GOOGLE_AUTH_ERROR') {
                debugLog(`‚ùå Auth Error: ${error}`);
                window.removeEventListener('message', messageListener);
                showAlert('danger', `Google Login Error: ${error}`);
            }
        };

        window.addEventListener('message', messageListener, false);

        // Backup: Watch if popup is closed manually without finishing
        const checkClosed = setInterval(function() {
            if (popup.closed) {
                clearInterval(checkClosed);
                // Wait a moment for the message listener to catch up
                setTimeout(() => {
                    debugLog('‚ÑπÔ∏è Popup closed');
                }, 1000);
            }
        }, 1000);
    }

    /**
     * Sends the code to the Django Backend
     */
    async function handleAuthorizationCode(code) {
        debugLog('üì§ Exchanging code for tokens with backend...');
        showAlert('info', 'Authenticating with Google...');

        try {
            const response = await axios.post('/api/auth/google-oauth/', {
                code: code,
                redirect_uri: REDIRECT_URI // Must match exactly what was sent to Google
            });

            if (response.data.success) {
                debugLog('‚úÖ Backend login successful');
                
                const { tokens, user } = response.data.data;
                
                // Save tokens
                localStorage.setItem('access_token', tokens.access);
                localStorage.setItem('refresh_token', tokens.refresh);
                localStorage.setItem('user_data', JSON.stringify(user));
                
                // Update axios for future requests
                axios.defaults.headers.common['Authorization'] = `Bearer ${tokens.access}`;

                showAlert('success', 'Logged in successfully! Redirecting...');
                
                // Determine dashboard based on user role
                const dashboardUrl = user.is_staff ? '/i/dashboard/' : '/e/dashboard/';
                
                setTimeout(() => {
                    window.location.href = dashboardUrl;
                }, 1000);
            }
        } catch (error) {
            const errorMsg = error.response?.data?.message || 'Failed to sync with backend';
            debugLog(`‚ùå Backend exchange failed: ${errorMsg}`);
            showAlert('danger', errorMsg);
        }
    }

    // --- Helper UI Functions ---

    function showAlert(type, message) {
        const container = document.getElementById('alertContainer');
        if (!container) return;

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 6000);
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initCustomGoogleAuth);
</script>