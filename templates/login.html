{% extends 'public/base.html' %}

{% block title %}Login - Django DRF Auth{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3>Login</h3>
            </div>
            <div class="card-body">
                <!-- Regular Login Form -->
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <span id="loginBtnText">Login</span>
                    </button>
                </form>

                <div class="text-center mb-3">
                    <span class="text-muted">Or</span>
                </div>

                <!-- Google Sign-In Button -->
                <button id="googleSignInBtn" class="btn btn-outline-danger w-100 mb-3">
                    <i class="fab fa-google me-2"></i>Sign in with Google
                </button>

                <!-- Test Buttons -->
                <div class="row">
                    <div class="col-6">
                        <button id="testCallback" class="btn btn-outline-info btn-sm w-100">
                            Test Callback
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="checkStorage" class="btn btn-outline-warning btn-sm w-100">
                            Check Storage
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register link -->
        <div class="text-center mt-3">
            <p class="text-muted">
                Don't have an account?
                <a href="{% url 'register_page' %}" class="text-decoration-none">Register here</a>
            </p>
        </div>
    </div>
</div>

<!-- Debug Console -->
<div class="row justify-content-center mt-3">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6>Debug Console</h6>
            </div>
            <div class="card-body">
                <div id="debugConsole" style="background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; height: 150px; overflow-y: auto; border: 1px solid #dee2e6;">
                    <!-- Debug messages will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer"></div>
{% endblock %}

{% block scripts %}
    <script>
    async function checkAuthAndRedirect() {
        const token = localStorage.getItem('access_token');

        if (!token) {
            debugLog('‚ÑπÔ∏è No token found, showing login page');
            return; // User is not logged in, show login page
        }

        debugLog('üîç Token found, verifying with server...');

        try {
            // Verify token with server and get user info
            const response = await fetch('/api/auth/profile/', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();

                if (data.success && data.data) {
                    const isStaff = data.data.is_staff || false;
                    const dashboardUrl = isStaff ? '/i/dashboard/' : '/e/dashboard/';

                    debugLog(`‚úÖ User already logged in (staff: ${isStaff})`);
                    showAlert('info', 'You are already logged in. Redirecting to dashboard...');

                    setTimeout(() => {
                        window.location.href = dashboardUrl;
                    }, 1000);

                    return true; // User is logged in
                }
            } else if (response.status === 401) {
                // Token is invalid or expired
                debugLog('‚ö†Ô∏è Token invalid or expired, clearing storage');
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_data');

                if (typeof axios !== 'undefined') {
                    delete axios.defaults.headers.common['Authorization'];
                }
            }
        } catch (error) {
            debugLog(`‚ùå Error checking auth: ${error.message}`);
            console.error('Auth check error:', error);
        }

        return false; // User is not logged in or token is invalid
    }

    // Helper function to determine dashboard URL based on user role
    function getDashboardUrl(userData) {
        const isStaff = userData.is_staff || false;
        return isStaff ? '/i/dashboard/' : '/e/dashboard/';
    }

    function debugLog(message) {
        const debugElement = document.getElementById('debugConsole');
        if (debugElement) {
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML += `[${timestamp}] ${message}<br>`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        window.console.log(message);
    }

    function showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer');
        if (!alertContainer) return;

        alertContainer.querySelectorAll(`.alert-${type}`).forEach(alert => alert.remove());

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);

        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 8000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
        debugLog('üöÄ Login page loaded');

        // Check if user is already logged in
        const isLoggedIn = await checkAuthAndRedirect();

        if (isLoggedIn) {
            // User is already logged in, redirect will happen
            // Hide the login form to prevent interaction
            const loginForm = document.getElementById('loginForm');
            const googleBtn = document.getElementById('googleSignInBtn');
            if (loginForm) loginForm.style.opacity = '0.5';
            if (googleBtn) googleBtn.disabled = true;
            return;
        }

        // User is not logged in, initialize login functionality
        debugLog('üìù Initializing login form');
    });
</script>

{% include 'partials/_js_google_auth.html' %}
{% endblock %}