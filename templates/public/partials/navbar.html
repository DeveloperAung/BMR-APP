{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
<!-- Bootstrap 5 JS (must include bundle) -->

<nav class="navbar navbar-expand-lg d-flex justify-content-between">
    <a class="navbar-brand" href="{% url 'home' %}">
        <img class="img-fluid" src="{% static 'BMR_logo.png' %}" alt="" style="max-width: 70px;">
    </a>
    <ul class="landing-menu nav nav-pills">
        <li class="nav-item mx-2"><a class="nav-link" href="{% url 'home' %}">Home</a></li>

        <li class="nav-item dropdown mx-2">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            About Us
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <li><a class="dropdown-item" href="{% url 'association_post_details' 'about_us' %}">About Us</a></li>
            <li><a class="dropdown-item" href="{% url 'association_post_details' 'objectives' %}">Objectives</a></li>
            <li><a class="dropdown-item" href="{% url 'association_post_details' 'biography' %}">Biography</a></li>
          </ul>
        </li>

                <li class="nav-item dropdown mx-2">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink2" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Courses
                    </a>
                    {% if event_category_menus %}
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink2">
                        {% for category in event_category_menus %}
                            <li><a class="dropdown-item" href="{% url 'association_post_details' 'about_us' %}">{{ category.title }}</a></li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <!-- Hide or show a disabled dropdown when there are no categories -->
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink2">
                            <li><span class="dropdown-item text-muted">No courses available</span></li>
                    </ul>
                    {% endif %}
                </li>
        <li class="nav-item mx-2"><a class="nav-link" href="{% url 'article_list' %}">Articles</a></li>
        <li class="nav-item mx-2"><a class="nav-link" href="{% url 'book_list' %}">Books</a></li>
        <li class="nav-item mx-2"><a class="nav-link" href="#core-feature">Activities</a></li>
        <li class="nav-item mx-2"><a class="nav-link" href="">Contact Us</a></li>
    </ul>

    <div class="buy-block">
        <!-- Authenticated User Section (Hidden by default) -->
        <div class="profile-nav onhover-dropdown" id="authSection" style="display: none;">
            <div class="user-wrap">
                <div class="user-img">
                    <img id="navUserAvatar" src="{% static 'assets/images/dashboard/profile.jpg' %}" alt="User">
                </div>
                <div class="user-content">
                    <h6 id="navUserName">User</h6>
                    <span class="text-white" id="navUserEmail">email@example.com</span>
                </div>
            </div>
            <div class="custom-menu">
                <ul class="profile-body">
                    <li class="d-flex">
                        <svg class="svg-color">
                            <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Home"></use>
                        </svg>
                        <a class="ms-2" href="/e/dashboard/">Dashboard</a>
                    </li>
                    <li class="d-flex">
                        <svg class="svg-color">
                            <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Setting"></use>
                        </svg>
                        <a class="ms-2" href="#" onclick="changePassword(); return false;">Change Password</a>
                    </li>
                    <li class="d-flex">
                        <svg class="svg-color">
                            <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Login"></use>
                        </svg>
                        <a class="ms-2" onclick="performLogout()" style="cursor: pointer;">
                            <span id="logoutText">Log Out</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Unauthenticated User Section (Hidden by default) -->
        <div class="auth-buttons" id="unauthSection" style="display: none;">
            <a href="/login/" class="btn btn-outline-primary btn-sm me-2">
                <i class="fa-solid fa-sign-in-alt me-1"></i>Login
            </a>
            <a href="/register/" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-user-plus me-1"></i>Register
            </a>
        </div>

        <div class="toggle-menu"><i class="fa-solid fa-bars"></i></div>
    </div>
</nav>

<style>
    .profile-nav {
        position: relative;
        cursor: pointer;
    }

    .user-wrap {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }

    .user-wrap:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .user-img img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
    }

    .user-content {
        margin-left: 10px;
        color: white;
    }

    .user-content h6 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
    }

    .user-content .text-muted {
        font-size: 12px;
        opacity: 0.8;
    }

    .profile-nav:hover .custom-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .profile-body {
        list-style: none;
        padding: 10px 0;
        margin: 0;
    }

    .profile-body li {
        padding: 8px 15px;
        transition: background-color 0.3s ease;
        cursor: pointer;
    }

    .profile-body li:hover {
        background-color: #f8f9fa;
    }

    .profile-body a {
        text-decoration: none;
        color: #333;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .svg-color {
        width: 16px;
        height: 16px;
        fill: #666;
    }

    /* Auth buttons styling */
    .auth-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .auth-buttons .btn {
        font-size: 14px;
        padding: 6px 16px;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .auth-buttons .btn-outline-light:hover {
        background-color: white;
        color: #333;
    }

    .auth-buttons .btn-light:hover {
        background-color: #f8f9fa;
    }

    /* Loading spinner */
    .logout-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 5px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* Ensure landing menu dropdowns match other navbar dropdowns */
    /* Positioning and appearance fixes so dropdowns behave like Bootstrap nav dropdowns */
    ul.landing-menu .nav-item.dropdown {
        position: relative;
    }

    ul.landing-menu .dropdown-menu {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        z-index: 1050;
        min-width: 200px;
        background-color: #ffffff;
        border-radius: 6px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        padding: 6px 0;
    }

    ul.landing-menu .dropdown-item {
        color: #333333;
        padding: 8px 16px;
        font-size: 14px;
    }

    ul.landing-menu .dropdown-item:hover,
    ul.landing-menu .dropdown-item:focus {
        background-color: #f8f9fa;
        color: #000;
    }

    /* Ensure dropdown caret is visible on desktop and matches link color */
    .navbar .nav-link.dropdown-toggle {
        color: inherit;
    }

    @media (min-width: 992px) {
        .landing-menu .nav-link.dropdown-toggle::after {
            /* make sure the caret uses the current color and is visible */
            border-top-color: currentColor !important;
            opacity: 1 !important;
            margin-left: 0.35rem !important;
        }
    }

    /* For small screens let dropdown behave as block inside mobile menu
       and appear like other menu items (no floating rounded boxes) */
    @media (max-width: 991px) {
        /* Keep dropdowns inline in mobile menu and match nav-link look */
        ul.landing-menu .dropdown-menu {
            position: static !important;
            box-shadow: none !important;
            background: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            border: 0 !important;
        }

        /* Make dropdown items match nav links */
        ul.landing-menu .dropdown-item {
            display: block !important;
            width: 100% !important;
            color: var(--body-font-color) !important;
            padding: 10px 20px !important;
            background: transparent !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            text-align: center !important;
        }

        ul.landing-menu .dropdown-item:hover,
        ul.landing-menu .dropdown-item:focus {
            background: rgba(0,0,0,0.03) !important;
            color: var(--theme-secondary) !important;
            text-align: center !important;
        }

        /* Remove the caret/arrow on mobile and make the parent link act like a header */
        ul.landing-menu .nav-link.dropdown-toggle::after {
            display: none !important;
        }

        /* Ensure nav-link parents don't have pill/rounded backgrounds on mobile */
        ul.landing-menu {
            padding-left: 0 !important;
        }
        ul.landing-menu li.nav-item {
            margin: 0 !important; /* remove side margins like mx-2 */
            text-align: center !important; /* center list items */
        }
        ul.landing-menu li.nav-item a.nav-link {
            background: transparent !important;
            border-radius: 0 !important;
            padding: 10px 0 !important; /* keep vertical padding but remove heavy side padding */
            display: block !important;
            color: var(--body-font-color) !important;
            text-align: center !important;
            width: 100% !important;
            margin: 0 auto !important;
        }
        /* specifically ensure dropdown toggles have no extra padding pushing text left */
        ul.landing-menu li.nav-item.dropdown > a.nav-link.dropdown-toggle {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* When the mobile menu is opened, position it below the header
           so it doesn't overlap the header; set top to 110px as requested */
        ul.landing-menu.open {
            top: 110px !important;
        }

        /* In case any .btn styles are applied inside the landing menu, neutralize them */
        ul.landing-menu .btn {
            padding: 0;
            background: transparent;
            border: 0;
            box-shadow: none;
            color: inherit;
        }

        /* Simplify profile block: show avatar + email in a single row */
        .profile-nav {
            display: flex !important;
            align-items: center;
            padding: 10px 20px;
            background: transparent;
            gap: 10px;
            justify-content: center; /* center profile on mobile */
        }
        .profile-nav .user-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0;
        }
        /* show email only when profile is inside mobile menu wrapper; hide on-screen but visible in sidebar */
        .profile-nav .user-content {
            display: none !important;
            align-items: center;
            gap: 8px;
            color: var(--body-font-color) !important;
        }
        .profile-nav .user-content h6 { display: none !important; }
        /* when moved into the mobile menu wrapper show the email */
        ul.landing-menu li.mobile-profile-wrapper .profile-nav .user-content {
            display: inline-flex !important;
        }
        ul.landing-menu li.mobile-profile-wrapper .profile-nav .user-content #navUserEmail {
            display: inline-block !important; color: var(--body-font-color) !important; font-size: 14px;
        }
        /* hide the dropdown custom menu on mobile to keep menu compact */
        .profile-nav .custom-menu { display: none !important; }
        .profile-nav .user-img img {
            width: 36px !important;
            height: 36px !important;
            border-radius: 50% !important;
            border: none !important;
        }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .custom-menu {
            right: -10px;
            left: -10px;
            min-width: auto;
        }

        .auth-buttons {
            flex-direction: column;
            gap: 4px;
        }

        .auth-buttons .btn {
            font-size: 12px;
            padding: 4px 12px;
        }
    }

    /* Mobile: when we inject profile into the menu, ensure it displays cleanly */
    @media (max-width: 991px) {
        ul.landing-menu li.mobile-profile-wrapper {
            list-style: none;
            padding: 0;
            margin: 0 0 8px 0;
        }
        ul.landing-menu li.mobile-profile-wrapper .profile-nav {
            display: flex !important;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
            box-sizing: border-box;
            background: transparent;
            justify-content: flex-start;
        }
    }
</style>

<script>
    // Function to update navbar based on authentication status
    function updateNavbarAuth() {
        const token = localStorage.getItem('access_token');
        const authSection = document.getElementById('authSection');
        const unauthSection = document.getElementById('unauthSection');

        if (token) {
            // User is authenticated
            authSection.style.display = 'block';
            unauthSection.style.display = 'none';
            loadUserProfile();
        } else {
            // User is not authenticated
            authSection.style.display = 'none';
            unauthSection.style.display = 'block';
        }
    }

    // Function to load user profile data
    async function loadUserProfile() {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            const response = await fetch('/api/auth/profile/', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data) {
                    const userData = data.data;

                    // Update profile picture
                    const avatarImg = document.getElementById('navUserAvatar');
                    if (userData.profile_picture) {
                        avatarImg.src = userData.profile_picture;
                    }

                    // Update user name
                    const userName = userData.first_name && userData.last_name
                        ? `${userData.first_name} ${userData.last_name}`
                        : userData.username || 'User';
                    document.getElementById('navUserName').textContent = userName;

                    // Update email
                    if (userData.email) {
                        const email = userData.email;
                        const [namePart, domainPart] = email.split('@');

                        if (namePart.length > 2) {
                            // Number of hidden chars = namePart length - 2 (first & last are visible)
                            const stars = '*'.repeat(namePart.length - 2);
                            const masked = `${namePart[0]}${stars}${namePart[namePart.length - 1]}@${domainPart}`;
                            document.getElementById('navUserEmail').textContent = masked;
                        } else {
                            // For very short emails, keep as is
                            document.getElementById('navUserEmail').textContent = email;
                        }
                    }
                }
            } else if (response.status === 401) {
                // Token is invalid, logout
                performLogout();
            }
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
    }

    // Enhanced logout function
    async function performLogout() {
        const logoutText = document.getElementById('logoutText');
        const originalText = logoutText.innerHTML;

        try {
            // Show loading state
            logoutText.innerHTML = 'Logging out... <span class="logout-spinner"></span>';

            const refreshToken = localStorage.getItem('refresh_token');
            const accessToken = localStorage.getItem('access_token');

            if (refreshToken && accessToken) {
                await fetch('/api/auth/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({refresh: refreshToken})
                });
            }
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            // Clear all auth data
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');

            // Clear axios authorization if exists
            if (typeof axios !== 'undefined') {
                delete axios.defaults.headers.common['Authorization'];
            }

            // Update navbar to show login/register
            updateNavbarAuth();

            // Reset logout text
            logoutText.innerHTML = originalText;

            // Show success message
            showAlert('success', 'Logged out successfully');

            // Redirect to login page
            setTimeout(() => {
                window.location.href = '/login/';
            }, 1000);
        }
    }

    // Function to change password (placeholder)
    function changePassword() {
        window.location.href = '/password/change/';
    }

    // Simple alert function
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateNavbarAuth();

        // Check auth status periodically
        setInterval(updateNavbarAuth, 60000); // Check every minute
    });

    // Check auth when page becomes visible
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
            updateNavbarAuth();
        }
    });

    // Listen for storage changes (for cross-tab synchronization)
    window.addEventListener('storage', function (e) {
        if (e.key === 'access_token' || e.key === 'refresh_token') {
            updateNavbarAuth();
        }
    });
</script>

<script>
    (function () {
        // Move profile/auth elements into mobile menu when it opens, and restore when closed
        const landingMenu = document.querySelector('ul.landing-menu');
        const toggle = document.querySelector('.toggle-menu');
        const menuBack = document.querySelector('.menu-back');
        const buyBlock = document.querySelector('.buy-block');
        const profileNav = document.querySelector('.profile-nav');
        const authButtons = document.querySelector('.auth-buttons');

        if (!landingMenu || !toggle || !buyBlock) return;

        // Save original positions to restore later
        const originalProfileParent = profileNav ? profileNav.parentNode : null;
        const originalProfileNext = profileNav ? profileNav.nextSibling : null;
        const originalAuthParent = authButtons ? authButtons.parentNode : null;
        const originalAuthNext = authButtons ? authButtons.nextSibling : null;

        function moveIntoMenu() {
            if (!profileNav && !authButtons) return;
            // If menu is open and we haven't moved yet
            if (landingMenu.classList.contains('open') && !landingMenu.querySelector('.mobile-profile-wrapper')) {
                const wrapper = document.createElement('li');
                wrapper.className = 'nav-item mobile-profile-wrapper';
                // append nodes into wrapper
                if (profileNav) wrapper.appendChild(profileNav);
                if (authButtons) wrapper.appendChild(authButtons);
                landingMenu.insertBefore(wrapper, landingMenu.firstChild);
            }
            // If menu closed, restore
            if (!landingMenu.classList.contains('open')) {
                const wrapper = landingMenu.querySelector('.mobile-profile-wrapper');
                if (wrapper) {
                    // restore profileNav
                    if (profileNav && originalProfileParent) {
                        if (originalProfileNext) originalProfileParent.insertBefore(profileNav, originalProfileNext);
                        else originalProfileParent.appendChild(profileNav);
                    }
                    // restore authButtons
                    if (authButtons && originalAuthParent) {
                        if (originalAuthNext) originalAuthParent.insertBefore(authButtons, originalAuthNext);
                        else originalAuthParent.appendChild(authButtons);
                    }
                    wrapper.remove();
                }
            }
        }

        // Run after toggle click (landing.js toggles class via jQuery)
        toggle.addEventListener('click', function () {
            // slight delay so other handlers finish toggling the class
            setTimeout(moveIntoMenu, 20);
        });
        if (menuBack) menuBack.addEventListener('click', function () { setTimeout(moveIntoMenu, 20); });

        // Also ensure correct placement on page load (in case menu is pre-open)
        document.addEventListener('DOMContentLoaded', function () { setTimeout(moveIntoMenu, 50); });
    })();
</script>

{% include 'partials/_js_auth.html' %}

</body>
</html>
