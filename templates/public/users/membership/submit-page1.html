{% extends 'public/users/membership/base-registration.html' %}
{% block steps %}
    <form id="membership-page1" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Step 1: Personal Info and Membership Type -->
        <div class="wizard-step" id="step-1">
            <h5 class="mb-3"><span class="badge rounded-pill badge-primary">Profile Info</span></h5>
            <div class="row">
                <div class="col-md-6">
                    <label for="profile_picture" class="form-label">Profile Picture <span
                            class="text-danger">*</span></label>
                    <div class="mb-2">
                        <img id="profile_picture_preview"
                             src="{% if initial_data.profile_picture %}{{ initial_data.profile_picture }}{% endif %}"
                             alt="Profile Preview"
                             class="img-thumbnail"
                             style="max-width: 150px;" {% if not initial_data.profile_picture %}display:
                             none;{% endif %}>
                    </div>
                    <input type="file"
                           class="form-control"
                           id="profile_picture"
                           name="profile_picture"
                           accept="image/*"
                           {% if not initial_data.profile_picture %}required{% endif %}>
                    <div class="form-text">
                        {% if initial_data.profile_picture %}
                            Current profile picture shown above. Upload new one to change.
                        {% else %}
                            Please upload a profile picture (max 2MB).
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="">
                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" min="5"
                               value="{{ initial_data.profile_info.name }}" required>
                    </div>
                    <div class="">
                        <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
                        <select class="form-select" id="gender" name="gender" required>
                            <option value="">Select</option>
                            {% for g in gender_choices %}
                                <option value="{{ g.id }}"
                                        {% if g.id == initial_data.profile_info.gender %}selected{% endif %}>{{ g.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="">
                        <label for="date_of_birth" class="form-label">Date of Birth <span
                                class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth"
                               value="{{ initial_data.profile_info.date_of_birth }}" required>
                    </div>
                    <div class="">
                        <label for="city_of_birth" class="form-label">City of Birth</label>
                        <input type="text" class="form-control" id="city_of_birth" name="city_of_birth"
                               value="{{ initial_data.profile_info.city_of_birth }}">
                    </div>
                    <div class="">
                        <label for="country_of_birth" class="form-label">Country of Birth <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="country_of_birth" name="country_of_birth" required>
                            <option value="">Select Country</option>
                            {% for c in countries %}
                                <option value="{{ c.id }}"
                                        {% if c.id == initial_data.profile_info.country_of_birth %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="">
                        <label for="citizenship" class="form-label">Citizenship <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="citizenship" name="citizenship" required>
                            <option value="">Select Citizenship</option>
                            {% for ci in citizenship %}
                                <option value="{{ ci.id }}"
                                        {% if ci.id == initial_data.profile_info.citizenship %}selected{% endif %}>{{ ci.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="">
                        <label for="membership_type" class="form-label">Membership Type <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="membership_type" name="membership_type" required>
                            <option value="">Select Membership Type</option>
                            {% for type in membership_types %}
                                <option value="{{ type.id }}"
                                        {% if initial_data.membership_type is not None and type.id|stringformat:"s" == initial_data.membership_type|stringformat:"s" %}
                                        selected
                                        {% endif %}>
                                    {{ type.name }} - ${{ type.amount }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <hr>
            <h5 class="mb-3"><span class="badge rounded-pill badge-primary">Contact Info</span></h5>
            <div class="row g-3">

                <div class="col-md-6">
                    <label for="mobile-input" class="form-label">Primary Contact <span
                            class="text-danger">*</span></label>
                    <input type="tel"
                           class="form-control"
                           id="mobile-input"
                           name="mobile"
                           value="{{ initial_data.contact_info.primary_contact }}"
                           required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label for="mobile-secondary-input" class="form-label">Secondary Contact</label>
                    <input type="tel"
                           class="form-control"
                           id="mobile-secondary-input"
                           name="secondary_contact"
                           value="{{ initial_data.contact_info.secondary_contact }}">
                    <div class="invalid-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label for="nric_fin" class="form-label">NRIC/FIN <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nric_fin" name="nric_fin"
                           value="{{ initial_data.contact_info.nric_fin }}" required>
                </div>

                <div class="col-md-6">
                    <label for="residential_status" class="form-label">Residential Status <span
                            class="text-danger">*</span></label>
                    <select class="form-select" id="residential_status" name="residential_status" required>
                        <option value="">Select Status</option>
                        {% for rs in residential_statuses %}
                            <option value="{{ rs.id }}"
                                    {% if rs.id == initial_data.contact_info.residential_status %}selected{% endif %}>{{ rs.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="postal_code" class="form-label">Postal Code <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="postal_code" name="postal_code"
                           value="{{ initial_data.contact_info.postal_code }}"" required>
                </div>
                <div class="col-md-6">
                    <label for="address" class="form-label">Address <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="address" name="address" rows="2"
                              required>{{ initial_data.contact_info.address }}</textarea>
                </div>
            </div>

            <div id="membership-type-info" class="mt-3 alert alert-info" style="display: none;">
              <strong>Member Type:</strong> <span id="member-type-label"></span><br>
              <strong>Membership Fee:</strong> $<span id="member-fee-amount"></span>
            </div>
            <div class="d-flex justify-content-end mt-4">
                <a href="{% url 'member_reg_step_2' %}" type="button" class="btn btn-primary" id="step1-next">Continue</a>
            </div>
        </div>

    </form>
    <script>
    document.getElementById('membership_type').addEventListener('change', updateMembershipInfo);
    document.getElementById('residential_status').addEventListener('change', updateMembershipInfo);
    document.getElementById('date_of_birth').addEventListener('change', updateMembershipInfo);
    function updateMembershipInfo() {

      const feeInfo = document.getElementById('membership-type-info');
      const memberTypeLabel = document.getElementById('member-type-label');
      const feeAmountSpan = document.getElementById('member-fee-amount');

      const membershipTypeSelect = document.getElementById('membership_type');
      const selectedOption = membershipTypeSelect.options[membershipTypeSelect.selectedIndex];

      const residentialStatus = document.getElementById('residential_status').value;
      const dob = document.getElementById('date_of_birth').value;



      const amountText = selectedOption.textContent;
      const amountMatch = amountText.match(/\$([0-9.]+)/); // Extract $amount from option text

      let fee = 0;
      if (amountMatch) {
        fee = parseFloat(amountMatch[1]);
      }

      // Determine Member Type
      const isOrdinary = ['singaporean', 'permanent_resident'].includes(residentialStatus);
      const isStudentPass = residentialStatus === 'student_pass';
      const isSenior = (() => {
        const birthDate = new Date(dob);
        const today = new Date();
        const age = today.getFullYear() - birthDate.getFullYear();
        const hasHadBirthday = today.getMonth() > birthDate.getMonth() || (
          today.getMonth() === birthDate.getMonth() && today.getDate() >= birthDate.getDate()
        );
        return (hasHadBirthday ? age : age - 1) >= 60;
      })();

      let finalFee = (isStudentPass || isSenior) ? (fee / 2) : fee;

      // Update DOM
      memberTypeLabel.textContent = isOrdinary ? 'Ordinary' : 'Associate';
      feeAmountSpan.textContent = finalFee.toFixed(2);
      feeInfo.style.display = 'block';
    }

    </script>
{% endblock %}