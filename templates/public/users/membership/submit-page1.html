{% extends 'public/users/membership/base-registration.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css">
{% endblock %}

{% block steps %}
    <form id="membership-page1" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Step 1: Personal Info and Membership Type -->
        <div class="wizard-step" id="step-1">
            <h5 class="mb-3"><span class="badge rounded-pill badge-primary">Profile Info</span></h5>
            <div class="row">
                <div class="col-md-6">
                    <label for="profile_picture" class="form-label">Profile Picture <span
                            class="text-danger">*</span></label>
                    <div class="mb-2">
                        <img id="profile_picture_preview"
                             src="{% if initial_data.profile_picture %}{{ initial_data.profile_picture }}{% endif %}"
                             alt="Profile Preview"
                             class="img-thumbnail"
                             style="max-width: 150px; {% if not initial_data.profile_picture %}display: none;{% endif %}">
                    </div>
                    <input type="file"
                           class="form-control"
                           id="profile_picture"
                           name="profile_picture"
                           accept="image/*"
                           {% if not initial_data.profile_picture %}required{% endif %}>
                    <div class="form-text">
                        {% if initial_data.profile_picture %}
                            Current profile picture shown above. Upload new one to change.
                        {% else %}
                            Please upload a profile picture (max 2MB).
                        {% endif %}
                    </div>
                    <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" minlength="5"
                               value="{{ initial_data.profile_info.name }}" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
                        <select class="form-select" id="gender" name="gender" required>
                            <option value="">Select</option>
                            {% for g in gender_choices %}
                                <option value="{{ g.id }}"
                                        {% if g.id == initial_data.profile_info.gender %}selected{% endif %}>{{ g.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="date_of_birth" class="form-label">Date of Birth <span
                                class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth"
                               value="{{ initial_data.profile_info.date_of_birth }}" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="city_of_birth" class="form-label">City of Birth</label>
                        <input type="text" class="form-control" id="city_of_birth" name="city_of_birth"
                               value="{{ initial_data.profile_info.city_of_birth }}">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="country_of_birth" class="form-label">Country of Birth <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="country_of_birth" name="country_of_birth" required>
                            <option value="">Select Country</option>
                            {% for c in countries %}
                                <option value="{{ c.id }}"
                                        {% if c.id == initial_data.profile_info.country_of_birth %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="citizenship" class="form-label">Citizenship <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="citizenship" name="citizenship" required>
                            <option value="">Select Citizenship</option>
                            {% for ci in citizenship %}
                                <option value="{{ ci.id }}"
                                        {% if ci.id == initial_data.profile_info.citizenship %}selected{% endif %}>{{ ci.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
            </div>
            <hr>
            <h5 class="mb-3"><span class="badge rounded-pill badge-primary">Contact Info</span></h5>
            <div class="row g-3">

                <div class="col-md-6">
                    <label for="mobile-input" class="form-label">Primary Contact <span
                            class="text-danger">*</span></label>
                    <input type="tel"
                           class="form-control"
                           id="mobile-input"
                           name="mobile"
                           value="{{ initial_data.contact_info.primary_contact }}"
                           required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label for="mobile-secondary-input" class="form-label">Secondary Contact</label>
                    <input type="tel"
                           class="form-control"
                           id="mobile-secondary-input"
                           name="secondary_contact"
                           value="{{ initial_data.contact_info.secondary_contact }}">
                    <div class="invalid-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label for="nric_fin" class="form-label">NRIC/FIN <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nric_fin" name="nric_fin"
                           pattern="[STFG]\d{7}[A-Z]"
                           value="{{ initial_data.contact_info.nric_fin }}" required>
                    <div class="form-text">Format: S1234567A</div>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label for="residential_status" class="form-label">Residential Status <span
                            class="text-danger">*</span></label>
                    <select class="form-select" id="residential_status" name="residential_status" required>
                        <option value="">Select Status</option>
                        {% for rs in residential_statuses %}
                            <option value="{{ rs.id }}"
                                    {% if rs.id == initial_data.contact_info.residential_status %}selected{% endif %}>{{ rs.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label for="postal_code" class="form-label">Postal Code <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="postal_code" name="postal_code"
                           value="{{ initial_data.contact_info.postal_code }}" required>
                    <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6">
                    <label for="address" class="form-label">Address <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="address" name="address" rows="2"
                              required>{{ initial_data.contact_info.address }}</textarea>
                    <div class="invalid-feedback"></div>
                </div>
            </div>

            <div id="membership-type-info" class="mt-3 alert alert-info">
              <strong>Member Type:</strong> <span id="member-type-label"></span><br>
              <strong>Membership Fee:</strong> $<span id="member-fee-amount"></span>
            </div>

            <div class="mb-3">
                <label for="membership_type" class="form-label">Membership Type <span
                        class="text-danger">*</span></label>
                <select class="form-select" id="membership_type" name="membership_type" required>
                    <option value="">Select Membership Type</option>
                    {% for type in membership_types %}
                        <option value="{{ type.id }}"
                                {% if initial_data.membership_type is not None and type.id|stringformat:"s" == initial_data.membership_type|stringformat:"s" %}
                                selected
                                {% endif %}>
                            {{ type.name }} - ${{ type.amount }}
                        </option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback"></div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary" id="step1-submit">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                    Continue to Step 2
                </button>
            </div>
        </div>

    </form>

{% block extra_js %}
<script type="module" src="{% static 'js/memberships/membershipPage1.js' %}"></script>
{% endblock %}
{% endblock %}