{% extends 'public/users/membership/base-registration.html' %}
{% load static %}
{% block steps %}
<form id="membership-page3" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="wizard-step" id="step-2">

        <div id="payment-feedback"></div>

        <!-- Payment Method Section -->
        <div class="mt-4">
            <h5 class="fw-bold mb-3">Select Payment Method</h5>

            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="payment_method" id="paynow" value="paynow" checked>
                <label class="form-check-label" for="paynow">PayNow</label>
            </div>
            <div id="paynow-section" class="ms-4 mb-3 text-center">
                <img id="dynamic-qr"
                     src="/static/assets/images/forms/qr-code.png"
                     alt="PayNow QR Code"
                     class="img-fluid border rounded p-2"
                     style="max-width:200px;">
                <p id="qr-info" class="small mt-2 text-muted">
                    Scan this QR code to make your payment via PayNow.
                </p>
            </div>

            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="payment_method" id="cash" value="cash">
                <label class="form-check-label" for="cash">Cash</label>
            </div>

            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="payment_method" id="bank_transfer" value="bank_transfer">
                <label class="form-check-label" for="bank_transfer">Bank Transfer</label>
            </div>

            <!-- Upload Screenshot Section -->
            <div id="upload-section" class="d-none ms-4 mb-3">
                <label for="payment_screenshot" class="form-label fw-semibold">Upload Payment Screenshot</label>
                <input type="file" class="form-control" id="payment_screenshot" name="payment_screenshot"
                       accept="image/*">
                <p class="small text-muted mt-1">Accepted formats: JPG, PNG (Max 5MB)</p>
                <div id="payment-preview-wrapper" class="d-none mt-3">
                    <p class="small text-muted mb-1">Screenshot Preview</p>
                    <img
                        id="payment-preview-image"
                        src=""
                        alt="Payment screenshot preview"
                        class="img-fluid border rounded"
                        style="max-width:240px;">
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div class="d-none mt-4 text-center" id="registration-success">
            <img src="/static/assets/images/gif/success/successful.gif" alt="Success" style="max-width:120px;">
            <h4 class="mt-3">Registration Successful!</h4>
            <p>Your reference number: <span id="success-reference-no"></span></p>
            <a href="/" class="btn btn-primary mt-2">Go to Home</a>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'member_reg_step_2' %}" type="button" class="btn btn-secondary" id="step2-prev">Previous</a>
            <button type="button" class="btn btn-primary" id="step2-next">Continue</button>
        </div>
    </div>
</form>

{{ payment_context|json_script:"payment-context-data" }}
{{ payment_context.payment_uuid|default_if_none:""|json_script:"payment-uuid" }}
{{ payment_context.payment_external_id|default_if_none:""|json_script:"payment-external-id" }}
{% block extra_js %}
<script type="module" src="{% static 'js/memberships/membershipPage3.js' %}"></script>

<script>
    const paymentExternalId = "{{ payment.payment_external_id }}";  // from template
    alert("Starting payment status polling for: " + paymentExternalId);
    const pollIntervalMs = 5000;  // 5 seconds
    const maxAttempts = 120;      // ~10 minutes
  
    let attempts = 0;
    let pollTimer = null;
  
    function showSuccessNotification() {
      // You can replace with your own toast component / Bootstrap alert
      alert("Payment received successfully! Redirecting to your summary page...");
    }
  
    function redirectToSuccessPage() {
      // Adjust URL to your real success page
      window.location.href = "{% url 'membership_details' %}";
    }
  
    async function checkPaymentStatus() {
      try {
        const response = await fetch(
          `/api/membership/payments/${paymentExternalId}status/`,
          {
            headers: {
              "Accept": "application/json",
            },
            credentials: "include",  // if using session auth
          }
        );
  
        if (!response.ok) {
          console.error("Failed to fetch status", response.status);
          return;
        }
  
        const data = await response.json();   // { success, message, data: { status, ... } }
        if (!data.success) {
          console.error("API error:", data.message);
          return;
        }
  
        const status = (data.data.status || "").toLowerCase();
        console.log("Payment status:", status);
  
        if (status === "paid") {
          clearInterval(pollTimer);
          showSuccessNotification();
          redirectToSuccessPage();
        }
      } catch (err) {
        console.error("Error checking payment status:", err);
      } finally {
        attempts += 1;
        if (attempts >= maxAttempts) {
          clearInterval(pollTimer);
          console.warn("Stopped polling after max attempts");
        }
      }
    }
  
    // Start polling when page loads
    document.addEventListener("DOMContentLoaded", () => {
      pollTimer = setInterval(checkPaymentStatus, pollIntervalMs);
    });
  </script>
{% endblock %}
{% endblock %}
