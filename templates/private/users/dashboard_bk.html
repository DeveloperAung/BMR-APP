{% extends 'private/partials/base.html' %}
{% load static %}
{% block title %}Users Management{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/users/dashboard.css' %}">
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-sm-6 col-12">
                    <h2>Users Management</h2>
                </div>
                <div class="col-sm-6 col-12">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'private_dashboard' %}">
                                <i class="iconly-Home icli svg-color"></i>
                            </a>
                        </li>
                        <li class="breadcrumb-item">Management</li>
                        <li class="breadcrumb-item active">Users</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Container-fluid starts-->
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body table-responsive">
                        <!-- Filters Section -->
                        <div class="filters-section">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label">Search Users</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchInput"
                                               placeholder="Search by email, username, or name...">
                                        <button class="btn btn-primary" type="button" id="searchBtn">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Staff Status</label>
                                    <select class="form-select" id="staffFilter">
                                        <option value="">All Users</option>
                                        <option value="true">Staff Only</option>
                                        <option value="false">Regular Users</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Email Status</label>
                                    <select class="form-select" id="verifiedFilter">
                                        <option value="">All</option>
                                        <option value="true">Verified</option>
                                        <option value="false">Unverified</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Sort By</label>
                                    <select class="form-select" id="orderingSelect">
                                        <option value="-date_joined">Newest First</option>
                                        <option value="date_joined">Oldest First</option>
                                        <option value="first_name">Name A-Z</option>
                                        <option value="-first_name">Name Z-A</option>
                                        <option value="email">Email A-Z</option>
                                        <option value="-email">Email Z-A</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Per Page</label>
                                    <select class="form-select" id="perPageSelect">
                                        <option value="30">30</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-outline-primary" id="clearFiltersBtn" title="Clear Filters">
                                        <i class="fa-solid fa-filter"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Loading Spinner -->
                        <div class="loading-spinner" id="loadingSpinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading users...</p>
                        </div>

                        <!-- Users Table -->
                        <div class="list-product">
                            <table class="table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>
                                            <div class="form-check">
                                                <input class="form-check-input checkbox-primary" type="checkbox" id="masterCheckbox"/>
                                            </div>
                                        </th>
                                        <th><span class="f-light f-w-600">User</span></th>
                                        <th><span class="f-light f-w-600">Email</span></th>
                                        <th><span class="f-light f-w-600">Username</span></th>
                                        <th><span class="f-light f-w-600">Role</span></th>
                                        <th><span class="f-light f-w-600">Status</span></th>
                                        <th><span class="f-light f-w-600">Joined Date</span></th>
                                        <th><span class="f-light f-w-600">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here via JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Results Info -->
                        <div class="results-info" id="resultsInfo">
                            <!-- Results information will be displayed here -->
                        </div>

                        <!-- Pagination -->
                        <div id="pagination">
                            <!-- Pagination will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Container-fluid Ends-->
<script>
    // Fixed Users Manager - resolves authentication and loading issues
class UsersManager {
    constructor() {
        this.debugMode = false;
        this.currentPage = 1;
        this.perPage = 30;
        this.currentFilters = {
            search: '',
            is_staff: '',
            is_verified: '',
            ordering: '-date_joined'
        };

        this.log('UsersManager initialized');
        this.updateDebugInfo('System initialized');
        this.init();
    }

    log(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`[${timestamp}] UsersManager:`, message, data || '');

        if (this.debugMode) {
            this.updateDebugInfo(`${timestamp}: ${message}${data ? ` - ${JSON.stringify(data)}` : ''}`);
        }
    }

    updateDebugInfo(message) {
        const debugContent = document.getElementById('debugContent');
        if (debugContent) {
            const existingContent = debugContent.innerHTML;
            debugContent.innerHTML = `<div>${message}</div>${existingContent}`.substring(0, 2000) + '...';
        }
    }

    init() {
        this.log('Initializing system...');

        // Check authentication first before doing anything
        const token = localStorage.getItem('access_token');
        if (!token) {
            this.log('No authentication token found - showing login message');
            this.showLoginRequired();
            return; // Stop initialization if not authenticated
        }

        this.checkPrerequisites();
        this.setupEventListeners();

        // Give a small delay to ensure DOM is fully ready
        setTimeout(() => {
            this.loadUsers();
        }, 100);
    }

    showLoginRequired() {
        const tbody = document.getElementById('usersTableBody');
        const spinner = document.getElementById('loadingSpinner');

        if (tbody) {
            tbody.innerHTML = `
                <tr><td colspan="8" class="text-center p-4">
                    <div class="alert alert-warning">
                        <h4><i class="fa fa-exclamation-triangle"></i> Authentication Required</h4>
                        <p>You need to be logged in to access user management.</p>
                        <div class="mt-3">
                            <a href="/login/" class="btn btn-primary">
                                <i class="fa fa-sign-in"></i> Go to Login
                            </a>
                            <button class="btn btn-secondary ms-2" onclick="location.reload()">
                                <i class="fa fa-refresh"></i> Refresh Page
                            </button>
                        </div>
                    </div>
                </td></tr>
            `;
        }

        if (spinner) {
            spinner.style.display = 'none';
        }

        this.showNotification('Please login to access user management', 'warning');
    }

    checkPrerequisites() {
        this.log('Checking prerequisites...');

        // Check authentication
        const token = localStorage.getItem('access_token');
        const refreshToken = localStorage.getItem('refresh_token');

        this.log('Authentication check', {
            hasAccessToken: !!token,
            hasRefreshToken: !!refreshToken,
            tokenLength: token ? token.length : 0
        });

        // Check required DOM elements
        const requiredElements = [
            'searchInput', 'searchBtn', 'staffFilter', 'verifiedFilter',
            'orderingSelect', 'perPageSelect', 'clearFiltersBtn',
            'loadingSpinner', 'usersTableBody', 'pagination', 'resultsInfo'
        ];

        const missingElements = requiredElements.filter(id => !document.getElementById(id));

        if (missingElements.length > 0) {
            this.log('Missing DOM elements', missingElements);
            this.showNotification('Some page elements are missing. Please refresh the page.', 'warning');
        }

        // Check CSRF token
        const csrfToken = this.getCsrfToken();
        this.log('CSRF token check', { hasToken: !!csrfToken, length: csrfToken.length });
    }

    setupEventListeners() {
        this.log('Setting up event listeners...');

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.handleSearch();
                }
            });
        }

        if (searchBtn) {
            searchBtn.addEventListener('click', () => this.handleSearch());
        }

        // Filter dropdowns
        const staffFilter = document.getElementById('staffFilter');
        const verifiedFilter = document.getElementById('verifiedFilter');
        const orderingSelect = document.getElementById('orderingSelect');
        const perPageSelect = document.getElementById('perPageSelect');

        if (staffFilter) {
            staffFilter.addEventListener('change', () => this.handleFilterChange());
        }

        if (verifiedFilter) {
            verifiedFilter.addEventListener('change', () => this.handleFilterChange());
        }

        if (orderingSelect) {
            orderingSelect.addEventListener('change', () => this.handleFilterChange());
        }

        if (perPageSelect) {
            perPageSelect.addEventListener('change', () => this.handlePerPageChange());
        }

        // Control buttons
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => this.clearFilters());
        }

        const toggleDebugBtn = document.getElementById('toggleDebugBtn');
        if (toggleDebugBtn) {
            toggleDebugBtn.addEventListener('click', () => this.toggleDebug());
        }

        this.log('Event listeners set up successfully');
    }

    toggleDebug() {
        this.debugMode = !this.debugMode;
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            debugInfo.style.display = this.debugMode ? 'block' : 'none';
        }
        this.log('Debug mode toggled', { enabled: this.debugMode });
    }

    getAuthToken() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            this.log('No authentication token found');
            this.showLoginRequired();
        }
        return token;
    }

    async makeApiCall(endpoint, options = {}) {
        this.log('Making API call', { endpoint, method: options.method || 'GET' });

        const token = this.getAuthToken();
        if (!token) return null;

        const defaultOptions = {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCsrfToken()
            }
        };

        const config = { ...defaultOptions, ...options };

        try {
            const response = await fetch(endpoint, config);
            this.log('API response received', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok
            });

            let data;
            try {
                data = await response.json();
                this.log('API response data', data);
            } catch (jsonError) {
                this.log('Failed to parse JSON response', jsonError.message);
                throw new Error('Invalid JSON response from server');
            }

            if (response.status === 401) {
                this.log('Authentication failed, attempting token refresh...');
                const refreshed = await this.refreshToken();
                if (refreshed) {
                    return this.makeApiCall(endpoint, options);
                }
                return null;
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${data.detail || data.message || response.statusText}`);
            }

            return { response, data };

        } catch (error) {
            this.log('API call failed', error.message);
            this.showNotification(`API Error: ${error.message}`, 'error');
            return null;
        }
    }

    getCsrfToken() {
        const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const token = tokenElement ? tokenElement.value : '';
        if (!token) {
            this.log('CSRF token not found');
        }
        return token;
    }

    async refreshToken() {
        this.log('Attempting token refresh...');
        const refreshToken = localStorage.getItem('refresh_token');

        if (!refreshToken) {
            this.log('No refresh token available');
            this.showNotification('Session expired. Please login again.', 'warning');
            this.showLoginRequired();
            return false;
        }

        try {
            const response = await fetch('/api/auth/token/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({ refresh: refreshToken })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('access_token', data.access);
                this.log('Token refreshed successfully');
                return true;
            } else {
                this.log('Token refresh failed', response.status);
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                this.showLoginRequired();
                return false;
            }
        } catch (error) {
            this.log('Token refresh error', error.message);
            this.showLoginRequired();
            return false;
        }
    }

    buildQueryParams() {
        const params = new URLSearchParams();
        params.append('page', this.currentPage);
        params.append('per_page', this.perPage);

        Object.keys(this.currentFilters).forEach(key => {
            if (this.currentFilters[key]) {
                params.append(key, this.currentFilters[key]);
            }
        });

        return params.toString();
    }

    async loadUsers() {
        this.log('Loading users...', { page: this.currentPage, perPage: this.perPage });
        this.showLoading(true);

        try {
            const queryParams = this.buildQueryParams();
            const endpoint = `/api/auth/users/?${queryParams}`;
            this.log('API endpoint', endpoint);

            const result = await this.makeApiCall(endpoint);

            if (result && result.data) {
                if (result.data.success) {
                    this.log('Users loaded successfully', {
                        userCount: result.data.data.results.length,
                        totalCount: result.data.data.pagination.total_count
                    });

                    this.renderUsers(result.data.data.results);
                    this.renderPagination(result.data.data.pagination);
                    this.updateResultsInfo(result.data.data.pagination);
                    this.showNotification('Users loaded successfully', 'success');
                } else {
                    this.log('API returned error', result.data.message);
                    this.renderError(result.data.message || 'Failed to load users');
                }
            } else {
                this.log('No data received from API');
                this.renderError('No response from server. Please check your connection.');
            }
        } catch (error) {
            this.log('Load users error', error.message);
            this.renderError(`Error loading users: ${error.message}`);
        } finally {
            this.showLoading(false);
        }
    }

    renderError(message) {
        this.log('Rendering error state', message);
        const tbody = document.getElementById('usersTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="error-state">
                            <div class="error-icon">⚠️</div>
                            <h5 class="text-danger">Error Loading Users</h5>
                            <p class="text-muted mb-3">${this.escapeHtml(message)}</p>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="usersManager.loadUsers()">
                                    <i class="fa fa-refresh"></i> Try Again
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="usersManager.toggleDebug()">
                                    <i class="fa fa-bug"></i> Show Debug Info
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
        this.showNotification(message, 'error');
    }

    renderUsers(users) {
        this.log('Rendering users', { count: users.length });
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) {
            this.log('Table body element not found');
            return;
        }

        if (!users || users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="error-state">
                            <div class="error-icon">👥</div>
                            <h5>No Users Found</h5>
                            <p class="text-muted">Try adjusting your search filters.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = users.map(user => `
            <tr class="user-row" data-user-id="${user.id}">
                <td>
                    <div class="form-check">
                        <input class="form-check-input checkbox-primary user-checkbox" type="checkbox" value="${user.id}"/>
                    </div>
                </td>
                <td>
                    <div class="product-names">
                        <div class="light-product-box">
                            <img class="img-fluid user-avatar"
                                 src="${user.profile_picture}"
                                 alt="${user.username}"
                                 onerror="this.src='/static/assets/images/user/1.jpg'"/>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold">${this.escapeHtml(user.first_name || '')} ${this.escapeHtml(user.last_name || '')}</p>
                            <small class="text-muted">@${this.escapeHtml(user.username)}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <p class="f-light mb-0">${this.escapeHtml(user.email)}</p>
                </td>
                <td>
                    <p class="f-light mb-0">${this.escapeHtml(user.username)}</p>
                </td>
                <td>
                    <span class="badge ${user.is_staff ? 'bg-success' : 'bg-primary'}">
                        ${user.is_staff ? 'Staff' : 'User'}
                    </span>
                </td>
                <td>
                    <span class="badge ${user.is_email_verified ? 'bg-success' : 'bg-warning'}">
                        ${user.is_email_verified ? 'Verified' : 'Unverified'}
                    </span>
                </td>
                <td>
                    <p class="f-light mb-0">${this.formatDate(user.date_joined)}</p>
                </td>
                <td>
                    <div class="product-action">
                        <button class="btn btn-sm btn-outline-primary" onclick="usersManager.viewUser(${user.id})" title="View User">
                            👁️
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="usersManager.editUser(${user.id})" title="Edit User">
                            ✏️
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="usersManager.deleteUser(${user.id}, '${this.escapeHtml(user.username)}')" title="Delete User">
                            🗑️
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        this.log('Users rendered successfully');
        this.setupBulkSelect();
    }

    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return 'Invalid Date';
        }
    }

    renderPagination(pagination) {
        this.log('Rendering pagination', pagination);
        const container = document.getElementById('pagination');
        if (!container || !pagination || pagination.total_pages <= 1) return;

        let html = '<nav><ul class="pagination justify-content-center">';

        // Previous button
        html += `
            <li class="page-item ${!pagination.has_previous ? 'disabled' : ''}">
                <button class="page-link" ${pagination.has_previous ? `onclick="usersManager.goToPage(${pagination.previous_page})"` : 'disabled'}>
                    Previous
                </button>
            </li>
        `;

        // Page numbers
        const start = Math.max(1, pagination.current_page - 2);
        const end = Math.min(pagination.total_pages, pagination.current_page + 2);

        if (start > 1) {
            html += `<li class="page-item"><button class="page-link" onclick="usersManager.goToPage(1)">1</button></li>`;
            if (start > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = start; i <= end; i++) {
            html += `
                <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                    <button class="page-link" onclick="usersManager.goToPage(${i})">${i}</button>
                </li>
            `;
        }

        if (end < pagination.total_pages) {
            if (end < pagination.total_pages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><button class="page-link" onclick="usersManager.goToPage(${pagination.total_pages})">${pagination.total_pages}</button></li>`;
        }

        // Next button
        html += `
            <li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
                <button class="page-link" ${pagination.has_next ? `onclick="usersManager.goToPage(${pagination.next_page})"` : 'disabled'}>
                    Next
                </button>
            </li>
        `;

        html += '</ul></nav>';
        container.innerHTML = html;
    }

    updateResultsInfo(pagination) {
        const info = document.getElementById('resultsInfo');
        if (info && pagination) {
            const start = ((pagination.current_page - 1) * pagination.per_page) + 1;
            const end = Math.min(pagination.current_page * pagination.per_page, pagination.total_count);
            info.textContent = `Showing ${start}-${end} of ${pagination.total_count} users`;
        }
    }

    goToPage(page) {
        this.log('Going to page', page);
        this.currentPage = page;
        this.loadUsers();
    }

    handleSearch() {
        this.log('Handling search...');
        const searchInput = document.getElementById('searchInput');
        this.currentFilters.search = searchInput ? searchInput.value.trim() : '';
        this.currentPage = 1;
        this.loadUsers();
    }

    handleFilterChange() {
        this.log('Handling filter change...');
        const staffFilter = document.getElementById('staffFilter');
        const verifiedFilter = document.getElementById('verifiedFilter');
        const orderingSelect = document.getElementById('orderingSelect');

        this.currentFilters.is_staff = staffFilter ? staffFilter.value : '';
        this.currentFilters.is_verified = verifiedFilter ? verifiedFilter.value : '';
        this.currentFilters.ordering = orderingSelect ? orderingSelect.value : '-date_joined';

        this.currentPage = 1;
        this.loadUsers();
    }

    handlePerPageChange() {
        this.log('Handling per page change...');
        const perPageSelect = document.getElementById('perPageSelect');
        this.perPage = perPageSelect ? parseInt(perPageSelect.value) : 30;
        this.currentPage = 1;
        this.loadUsers();
    }

    clearFilters() {
        this.log('Clearing filters...');
        const searchInput = document.getElementById('searchInput');
        const staffFilter = document.getElementById('staffFilter');
        const verifiedFilter = document.getElementById('verifiedFilter');
        const orderingSelect = document.getElementById('orderingSelect');

        if (searchInput) searchInput.value = '';
        if (staffFilter) staffFilter.value = '';
        if (verifiedFilter) verifiedFilter.value = '';
        if (orderingSelect) orderingSelect.value = '-date_joined';

        this.currentFilters = {
            search: '',
            is_staff: '',
            is_verified: '',
            ordering: '-date_joined'
        };
        this.currentPage = 1;
        this.loadUsers();
    }

    setupBulkSelect() {
        const masterCheckbox = document.getElementById('masterCheckbox');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');

        if (masterCheckbox) {
            masterCheckbox.addEventListener('change', (e) => {
                userCheckboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
                this.updateBulkActions();
            });
        }

        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                this.updateBulkActions();
                const checkedCount = document.querySelectorAll('.user-checkbox:checked').length;
                if (masterCheckbox) {
                    masterCheckbox.checked = checkedCount === userCheckboxes.length;
                    masterCheckbox.indeterminate = checkedCount > 0 && checkedCount < userCheckboxes.length;
                }
            });
        });
    }

    updateBulkActions() {
        const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
        const container = document.getElementById('bulkActions');

        if (container) {
            if (selectedCount > 0) {
                container.style.display = 'block';
                const countElement = container.querySelector('.selected-count');
                if (countElement) {
                    countElement.textContent = `${selectedCount} users selected`;
                }
            } else {
                container.style.display = 'none';
            }
        }
    }

    showLoading(show) {
        this.log('Show loading', show);
        const spinner = document.getElementById('loadingSpinner');
        const table = document.getElementById('usersTable');

        if (spinner) {
            spinner.style.display = show ? 'block' : 'none';
        }
        if (table) {
            table.style.opacity = show ? '0.5' : '1';
        }
    }

    showNotification(message, type = 'info') {
        this.log('Showing notification', { message, type });

        // Remove existing notifications
        document.querySelectorAll('.alert-notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show alert-notification`;

        notification.innerHTML = `
            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${this.escapeHtml(message)}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // User action methods
    async viewUser(userId) {
        this.log('Viewing user', userId);
        this.showLoading(true);
        
        try {
            const response = await this.makeApiCall(`/api/auth/users/${userId}/`);
            if (response && response.data) {
                this.showUserModal(response.data);
            } else {
                throw new Error('No user data received');
            }
        } catch (error) {
            console.error('Error fetching user details:', error);
            this.showNotification(
                error.response?.data?.detail || 'Failed to load user details. Please try again.',
                'error'
            );
        } finally {
            this.showLoading(false);
        }
    }
    
    showUserModal(user) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('userViewModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'userViewModal';
            modal.className = 'modal fade';
            modal.tabIndex = '-1';
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">User Profile</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0" id="userDetailsContent">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Format user data for display
        const fullName = `${user.data.email}`;
        const userRole = user.data.is_superuser ? 'Super Admin' : 
                        user.data.is_staff ? 'Staff' : 'User';
        const loginMethod = user.data.is_google_login ? 'Google' : 'Email/Password';
        
        const userDetails = `
            <div class="row">
                <!-- Left Column -->
                <div class="col-xl-4">
                    <div class="card h-100">
                        <div class="card-header card-no-border pb-0">
                            <div class="card-options">
                                <a class="card-options-collapse" href="#" data-bs-toggle="card-collapse">
                                    <i class="fe fe-chevron-up"></i>
                                </a>
                                <a class="card-options-remove" href="#" data-bs-dismiss="modal">
                                    <i class="fe fe-x"></i>
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <img class="img-100 rounded-circle mb-3" 
                                     src="${user.data.profile_picture || '/static/assets/images/user/1.jpg'}"
                                     alt="Profile"
                                     onerror="this.src='/static/assets/images/user/1.jpg'"
                                     style="width: 100px; height: 100px; object-fit: cover;">
                                <h3 class="mb-1">${this.escapeHtml(fullName)}</h3>
                                <p class="text-uppercase text-muted"><i class="badge rounded-pill badge-primary">${userRole}</i> </p>
                                <span class="badge badge-pill ${user.data.is_active ? 'bg-success' : 'bg-danger'}">
                                    ${user.data.is_active ? 'Active' : 'Inactive'}
                                </span>
                                <span class="mt-2 badge badge-pill ${user.data.is_email_verified ? 'bg-success' : 'bg-danger'}">
                                    ${user.data.is_email_verified ? 'Verified' : 'Email Not Verified'}
                                </span>
                            </div>
                                                                                                              
                        </div>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="col-xl-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="mb-3">                                
                                <label class="form-label">Username</label>
                                <input class="form-control" value="${this.escapeHtml(user.data.username || 'N/A')}" readonly>                                
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <div class="input-group">
                                    <input class="form-control" value="${this.escapeHtml(user.data.email || 'N/A')}" readonly>
                                    <span class="input-group-text">
                                        <i class="fa ${user.data.is_email_verified ? 'fa-check-circle text-success' : 'fa-exclamation-circle text-warning'}" 
                                           title="${user.data.is_email_verified ? 'Email Verified' : 'Email Not Verified'}"></i>
                                    </span>
                                </div>
                            </div>  

                            <div class="mb-3">
                                <label class="form-label">Mobile</label>
                                <input class="form-control" value="${this.escapeHtml(user.data.mobile || 'N/A')}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Secondary Mobile</label>
                                <input class="form-control" value="${this.escapeHtml(user.data.secondary_mobile || 'N/A')}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Login Method</label>
                                <div class="input-group">
                                    <input class="form-control" value="${loginMethod}" readonly>
                                    <span class="input-group-text">
                                        ${user.data.is_google_login ? 
                                            '<i class="fa fa-google text-danger"></i>' : 
                                            '<i class="fa fa-envelope text-primary"></i>'}
                                    </span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Last Login</label>
                                    <input class="form-control" 
                                           value="${user.data.last_login ? this.formatDate(user.data.last_login) : '-'}" 
                                           readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date Joined</label>
                                    <input class="form-control" 
                                           value="${this.formatDate(user.data.date_joined)}" 
                                           readonly>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Update modal content
        const content = modal.querySelector('#userDetailsContent');
        if (content) {
            content.innerHTML = userDetails;
        }
        
        // Show the modal
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    }

    async editUser(userId) {
        this.log('Editing user', userId);
        this.showNotification(`Edit user ${userId} - Feature in development`, 'info');
    }

    async deleteUser(userId, username) {
        this.log('Deleting user', { userId, username });
        if (confirm(`Delete user "${username}"? This action cannot be undone.`)) {
            this.showNotification(`Delete user ${userId} - Feature in development`, 'warning');
        }
    }

    // Add this helper method
    clearSelection() {
        // Uncheck master checkbox
        const masterCheckbox = document.getElementById('masterCheckbox');
        if (masterCheckbox) {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = false;
        }

        // Uncheck all user checkboxes
        document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
            checkbox.checked = false;
        });

        // Hide bulk actions
        this.updateBulkActions();
    }

    hideModal() {
        const modal = document.getElementById('userModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
}

// Fixed initialization - no double initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking authentication...');

    const token = localStorage.getItem('access_token');
    console.log('Token check:', !!token);

    if (!token) {
        console.log('No token found - showing login message');
        // Show login required message immediately
        document.getElementById('usersTableBody').innerHTML = `
            <tr><td colspan="8" class="text-center p-4">
                <div class="alert alert-warning">
                    <h4><i class="fa fa-exclamation-triangle"></i> Authentication Required</h4>
                    <p>You need to be logged in to access user management.</p>
                    <div class="mt-3">
                        <a href="/login/" class="btn btn-primary">
                            <i class="fa fa-sign-in"></i> Go to Login
                        </a>
                        <button class="btn btn-secondary ms-2" onclick="location.reload()">
                            <i class="fa fa-refresh"></i> Refresh Page
                        </button>
                    </div>
                </div>
            </td></tr>
        `;
        document.getElementById('loadingSpinner').style.display = 'none';
        return; // Stop here if not authenticated
    }

    try {
        // Only initialize if we have a token
        console.log('Token found - initializing UsersManager');
        window.usersManager = new UsersManager();
        console.log('UsersManager initialized successfully');

        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            if (window.usersManager) {
                window.usersManager.log('Global error caught', e.error.message);
                window.usersManager.showNotification('An unexpected error occurred', 'error');
            }
        });

    } catch (error) {
        console.error('Failed to initialize UsersManager:', error);

        // Show fallback error message
        const errorHtml = `
            <tr><td colspan="8" class="text-center p-4">
                <div class="alert alert-danger">
                    <h4><i class="fa fa-exclamation-triangle"></i> System Error</h4>
                    <p><strong>Failed to initialize the user management system.</strong></p>
                    <p>Error: ${error.message}</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fa fa-refresh"></i> Reload Page
                        </button>
                    </div>
                </div>
            </td></tr>
        `;

        const tbody = document.getElementById('usersTableBody');
        if (tbody) {
            tbody.innerHTML = errorHtml;
        }

        document.getElementById('loadingSpinner').style.display = 'none';
    }
});
</script>
{% endblock %}