{% extends 'private/partials/base.html' %}
{% load static %}

{% block title %}Membership Approval{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-sm-6 col-12">
                <h2>Membership Approval</h2>
            </div>
            <div class="col-sm-6 col-12">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'private_dashboard' %}">
                            <i class="iconly-Home icli svg-color"></i>
                        </a>
                    </li>
                    <li class="breadcrumb-item">Memberships Approval</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-12">
            <div class="card shadow-sm border-primary">
                <div class="card-header bg-primary py-3">
                    <h5 class="mb-0">
                        <span class="fas {% if mode == 'edit' %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"> Reference No.: {{ member.reference_no }}</span>
                        <span class="badge badge-secondary" id="workflow-status-label">{{ member.workflow_status.external_status }}</span>
                    </h5>
                </div>
                <div class="card-body">                
                    <div id="result"></div>
                        <!-- Step 1: Personal Info and Membership Type -->
                        <div class="wizard-step" id="step-1">
                            <h5 class="mb-3"><span class="badge rounded-pill badge-primary">Profile Info</span></h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="name" name="name" minlength="5"
                                               value="{{ member.profile_info.full_name }}" required>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="gender" value="{{ member.profile_info.get_gender_display }}" readonly>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="date_of_birth" class="form-label">Date of Birth <span
                                                class="text-danger">*</span></label>
                                        <input class="form-control" id="date_of_birth" name="date_of_birth" value="{{ member.profile_info.date_of_birth }}" readonly>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="city_of_birth" class="form-label">City of Birth</label>
                                        <input type="text" class="form-control" id="city_of_birth" name="city_of_birth" value="{{ member.profile_info.city_of_birth }}" readonly >
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="country_of_birth" class="form-label">Country of Birth <span
                                                class="text-danger">*</span></label>
                                        <input type="text" id="country_of_birth" class="form-control" value="{{ member.profile_info.get_country_of_birth_display }}" readonly>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="citizenship" class="form-label">Citizenship <span
                                                class="text-danger">*</span></label>
                                        <input type="text" id="citizenship" class="form-control" value="{{ member.profile_info.get_citizenship_display }}" readonly>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="" class="form-label">Profile Picture <span
                                            class="text-danger">*</span></label>
                                    <div class="mb-2">
                                        <img id="profile_picture_preview"
                                             src="{% if member.profile_picture %}{{ member.profile_picture.url }}{% endif %}"
                                             alt="Profile Preview"
                                             class="img-thumbnail"
                                             style="max-width: 150px;">
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <hr>
                            <h5 class="mb-3"><span class="badge rounded-pill badge-primary">Contact Info</span></h5>
                            <div class="row g-3">

                                <div class="col-md-6">
                                    <label for="mobile" class="form-label">Primary Contact <span
                                            class="text-danger">*</span></label>
                                    <div class="masked-field-wrapper">
                                        <input type="tel"
                                               class="form-control"
                                               id="mobile"
                                               name="mobile"
                                               value="{{ member.contact_info.primary_contact }}"
                                               readonly>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-6">
                                    <label for="secondary_contact" class="form-label">Secondary Contact</label>
                                    <div class="masked-field-wrapper">
                                        <input type="tel"
                                               class="form-control"
                                               id="secondary_contact"
                                               name="secondary_contact"
                                               value="{% if member.contact_info.secondary_contact %}{{ member.contact_info.secondary_contact }}{% else %}-{% endif %}"
                                               readonly
                                        >
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-6">
                                    <label for="nric_fin" class="form-label">NRIC/FIN <span class="text-danger">*</span></label>
                                    <div class="masked-field-wrapper">
                                        <input type="text"
                                               class="form-control"
                                               id="nric_fin"
                                               name="nric_fin"
                                               value="{{ member.contact_info.nric_fin }}"
                                               required>
                                    </div>
                                    <div class="form-text">Format: S1234567A</div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-6">
                                    <label for="residential_status" class="form-label">Residential Status <span
                                            class="text-danger">*</span></label>
                                    <input type="text" id="residential_status" class="form-control" value="{{ member.contact_info.get_residential_status_display }}" readonly>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-6">
                                    <label for="postal_code" class="form-label">Postal Code <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code" value="{{ member.contact_info.postal_code }}" readonly>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="address" class="form-label">Address <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="address" name="address" rows="2"
                                              readonly>{{ member.contact_info.address }}</textarea>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            

                            <hr>
                        </div>

                        <div class="wizard-step" id="step-2">
                            <h5 class="mb-3"><span class="badge badge-primary">Education Info</span></h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="education" class="form-label">Education Level <span class="text-danger">*</span></label>

                                    <input type="text" id="education" class="form-control" value="{{ member.education_info.education.name }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="institution" class="form-label">Institution</label>
                                    <input type="text" id="institution" class="form-control" value="{{ member.education_info.institution.name }}" readonly>
                                </div>
                                <div class="col-12">
                                    <label for="other_societies" class="form-label">Other Societies</label>
                                    <textarea class="form-control" id="other_societies" name="other_societies" rows="2" readonly>{{ member.education_info.other_societies }}</textarea>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h5 class="mb-3"><span class="badge badge-primary">Work Info</span></h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="occupation" class="form-label">Occupation <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="occupation" name="occupation" value="{{ member.work_info.occupation }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="company_name" class="form-label">Company Name</label>
                                    <input type="text" class="form-control" id="company_name" name="company_name" value="{{ member.work_info.company_name }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="company_contact" class="form-label">Company Contact</label>
                                    <input type="text" class="form-control" id="company_contact" name="company_contact" value="{{ member.work_info.company_contact }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="company_postal_code" class="form-label">Company Postal Code</label>
                                    <input type="text" class="form-control" id="company_postal_code" name="company_postal_code" value="{{ member.work_info.company_postal_code }}" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label for="company_address" class="form-label">Company Address</label>
                                    <textarea class="form-control" id="company_address" name="company_address" readonly
                                              rows="2">{{ member.work_info.company_address }}</textarea>
                                </div>
                            </div>                            
                            </div>

                            <!-- Offline payment screenshot(s) -->
                            <hr class="my-4">
                            <h5 class="mb-3"><span class="badge badge-secondary">Offline Payment</span></h5>
                            <div class="row g-3 mb-3" id="offline-payments">
                                {% with payments=member.payments.all|dictsortreversed:"created_at" %}
                                    {% if payments %}
                                        <div class="col-12">
                                            <p class="mb-2 small text-muted">Uploaded payment slip(s) (click to view full size)</p>
                                            <div class="d-flex flex-wrap gap-2">
                                                {% for p in payments %}
                                                    {% if p.receipt_image %}
                                                        <div class="card p-2" style="width: 140px;">
                                                            <a href="{{ p.receipt_image.url }}" target="_blank" rel="noopener noreferrer">
                                                                <img src="{{ p.receipt_image.url }}" alt="Receipt {{ p.receipt_no }}" class="img-fluid img-thumbnail" style="max-height:110px; object-fit:cover;">
                                                            </a>
                                                            <div class="mt-2 small">
                                                                <div><strong>{{ p.receipt_no }}</strong></div>
                                                                <div class="text-muted">{{ p.amount }} {{ p.currency }}</div>
                                                                <div class="text-muted">{{ p.get_status_display }}</div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% empty %}
                                                    <div class="text-muted small">No payment slips uploaded.</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="col-12 text-muted small">No payment records.</div>
                                    {% endif %}
                                {% endwith %}
                            </div>

                            {% if member.workflow_status.status_code == "12" %} true {% endif %}
                            {% if member.workflow_status.status_code == "12" %}
                            <hr class="p-2">
                            <div class="col-md-12">
                                <label for="remarks" class="form-label">Remarks</label>
                                    <textarea class="form-control" id="remarks" name="remarks"
                                              rows="2" placeholder="Leave a note for the applicant">{{ member.reason }}</textarea>
                                    <div class="form-text">Remarks are required when rejecting or requesting revisions.</div>
                            </div>
                            <div class="text-end mt-3" id="workflow-actions" data-member-uuid="{{ member.uuid }}">
                                <button class="btn btn-danger btn-air-light me-2" type="button" data-action="reject">Reject</button>
                                <button class="btn btn-warning btn-air-light me-2" type="button" data-action="revise">Revise</button>
                                <button class="btn btn-success btn-air-light me-2" type="button" data-action="approve">Approve</button>
                            </div>
                            {% endif %}
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>
   
{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'js/memberships/approvalPage.js' %}"></script>
{% endblock %}
