{% extends 'private/partials/base.html' %}

{% block title %}Create Category - Simple Token{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>Create Category (Simple Token Access)</h2>

    <form id="simpleTokenForm">
        <div class="mb-3">
            <label>Title:</label>
            <input type="text" id="title" class="form-control" value="Test Category" required>
        </div>

        <div class="mb-3">
            <label>
                <input type="checkbox" id="is_date_required" checked> Require Date
            </label>
        </div>

        <div class="mb-3">
            <label>
                <input type="checkbox" id="is_multi_select_required" checked> Multi Select
            </label>
        </div>

        <button type="submit" class="btn btn-primary">Create</button>
    </form>

    <div id="result" class="mt-3"></div>

    <div class="mt-3">
        <button onclick="checkTokens()" class="btn btn-info">Check Tokens</button>
        <button onclick="testAPI()" class="btn btn-warning">Test API Access</button>
    </div>
</div>

<script>
// Simple token access functions
function getAccessToken() {
    return localStorage.getItem('access_token');
}

function getCSRFToken() {
    // Try multiple ways to get CSRF token
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) return metaToken.getAttribute('content');

    const inputToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (inputToken) return inputToken.value;

    // Try cookie
    const value = `; ${document.cookie}`;
    const parts = value.split(`; csrftoken=`);
    if (parts.length === 2) {
        return parts.pop().split(';').shift();
    }

    return '';
}

function checkTokens() {
    const accessToken = getAccessToken();
    const csrfToken = getCSRFToken();

    console.log('Access Token:', accessToken);
    console.log('CSRF Token:', csrfToken);

    document.getElementById('result').innerHTML = `
        <div class="alert alert-info">
            <h5>Token Status:</h5>
            <p><strong>Access Token:</strong> ${accessToken ? 'Found' : 'Missing'}</p>
            <p><strong>CSRF Token:</strong> ${csrfToken ? 'Found' : 'Missing'}</p>
        </div>
    `;
}

async function testAPI() {
    const resultDiv = document.getElementById('result');
    const accessToken = getAccessToken();

    if (!accessToken) {
        resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå No access token found. Please login.</div>';
        return;
    }

    try {
        resultDiv.innerHTML = '<div class="alert alert-info">Testing API...</div>';

        // Test GET first
        const response = await fetch('/api/donations/categories/', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (response.ok) {
            resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ API access working! Found ' + (result.results?.length || 0) + ' categories.</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå API Error: ' + response.status + ' - ' + (result.detail || result.message) + '</div>';
        }

    } catch (error) {
        resultDiv.innerHTML = '<div class="alert alert-danger">üí• Network Error: ' + error.message + '</div>';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('simpleTokenForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const resultDiv = document.getElementById('result');
        const accessToken = getAccessToken();
        const csrfToken = getCSRFToken();

        if (!accessToken) {
            resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå No access token. Please login first.</div>';
            return;
        }

        const data = {
            title: document.getElementById('title').value,
            is_date_required: document.getElementById('is_date_required').checked,
            is_multi_select_required: document.getElementById('is_multi_select_required').checked
        };

        try {
            resultDiv.innerHTML = '<div class="alert alert-info">Creating category...</div>';

            const response = await fetch('/api/donations/categories/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                resultDiv.innerHTML = '<div class="alert alert-success">‚úÖ Success! Category created: ' + result.data.title + '</div>';

                setTimeout(() => {
                    window.location.href = '/donations/categories/';
                }, 2000);

            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error: '+ error.status  + (result.message || result.detail || 'Unknown error') + '</div>';
            }

        } catch (error) {
            resultDiv.innerHTML = '<div class="alert alert-danger">üí• Error: ' + error.message + error.status + '</div>';
        }
    });

    // Auto-check tokens on load
    checkTokens();
});
</script>
{% endblock %}